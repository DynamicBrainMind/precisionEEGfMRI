# Import libraries
rm(list=ls())
library(tidyverse)
library(data.table)
library(glue)
library(future.apply)
library(here)
library(fs)
library(arrow)
script_root <- path(here(), 'analysis/scripts/modules/preprocessing')
source(path(script_root, '04a-compile_condition_codes.r'))
compute_correlations <- function(d, script_root, by_task=FALSE) {
setDT(d)
# Make cache dir
if (!dir.exists(path(script_root, 'cache'))) {
dir.create(path(script_root, 'cache'))
}
# Identify EEG and fMRI columns
first_eeg_col <- colnames(d)[which(grepl('^Fp1', colnames(d)))[1]]
if (is.na(first_eeg_col)) stop('No EEG column starting with "Fp1" found.')
eeg_cols <- colnames(d)[which(colnames(d) == first_eeg_col):(ncol(d))]
fmri_cols <- colnames(d)[(which(colnames(d) == 'tr')+1):(which(colnames(d) == first_eeg_col)-1)]
# Get networks from d
# Make running by condition conditional on user input
if (by_task) {
condition_codes <- get_condition_codes(data_root, network=fmri_cols[1])
d <- inner_join(d, condition_codes)
# Rearrange columns
d <- d[, c(colnames(condition_codes), colnames(d)[!colnames(d) %in% colnames(condition_codes)])]
}
# Split data by subject, session, run
if (by_task) {
d[, run_id := paste(subject, session, run, condition, sep = '_')]
} else {
d[, run_id := paste(subject, session, run, sep = '_')]
}
# Get unique run_ids to distribute to workers
run_ids <- unique(d$run_id)
# Plan parallelization
workers <- max(1, parallel::detectCores()-10)
if (interactive() && .Platform$OS.type == 'unix') {
# Interactive RStudio, use safer multisession
plan(multisession, workers = 1)
} else if (.Platform$OS.type == 'unix') {
plan(multicore, workers=workers)
} else {
plan(multisession, workers = min(workers, 2))
}
# Increase globals size to avoid serialization errors
options(future.globals.maxSize = 8 * 1024^3) # 8 GB
print('Computing correlations...')
future_lapply(run_ids, function(rid) {
run_df <- d[run_id == rid]
eeg_mat <- as.matrix(run_df[, ..eeg_cols])
fmri_mat <- as.matrix(run_df[, ..fmri_cols])
cor_mat <- cor(eeg_mat, fmri_mat, method = 'spearman')
formatted <- format_cors(cor_mat, rid, by_task = by_task)
write_feather(formatted, path(script_root, glue('cache/{rid}.feather')))
NULL
}, future.seed = FALSE)
source("~/Documents/scripts/eeg-fmri-ml/analysis/scripts/modules/preprocessing/04-compute_correlations.r")
source("~/Documents/scripts/eeg-fmri-ml/analysis/scripts/modules/preprocessing/04-compute_correlations.r")
# --- LIBRARIES --- #
rm(list=ls())
library(arrow)
library(ggridges)
library(tidyverse)
library(eegUtils)
library(glue)
library(data.table)
library(ggpubr)
library(here)
library(fs)
library(psych)
library(scales)
library(RColorBrewer)
library(reticulate)
setwd(path(here()))
root <- path('analysis/scripts/sandbox/figures/correlations')
source(path(root, 'cor_viz_helpers/heat_maps/plot_heat_maps.r')) # plot_heat()
setwd("~/Documents/scripts/eeg-fmri-ml/analysis/scripts/sandbox/figures/correlations")
# --- LIBRARIES --- #
rm(list=ls())
library(arrow)
library(ggridges)
library(tidyverse)
library(eegUtils)
library(glue)
library(data.table)
library(ggpubr)
library(here)
library(fs)
library(psych)
library(scales)
library(RColorBrewer)
library(reticulate)
setwd(path(here()))
root <- path('analysis/scripts/sandbox/figures/correlations')
source(path(root, 'cor_viz_helpers/heat_maps/plot_heat_maps.r')) # plot_heat()
# --- LIBRARIES --- #
rm(list=ls())
library(arrow)
library(ggridges)
library(tidyverse)
library(eegUtils)
library(glue)
library(data.table)
library(ggpubr)
library(here)
library(fs)
library(psych)
library(scales)
library(RColorBrewer)
library(reticulate)
setwd(path(here()))
root <- path('analysis/scripts/sandbox/figures/correlations')
source(path(root, 'cor_viz_helpers/heat_maps/plot_heat_maps.r')) # plot_heat()
# --- LIBRARIES --- #
rm(list=ls())
library(arrow)
library(ggridges)
library(tidyverse)
library(eegUtils)
library(glue)
library(data.table)
library(ggpubr)
library(here)
library(fs)
library(psych)
library(scales)
library(RColorBrewer)
library(reticulate)
setwd(path(here()))
root <- path('analysis/scripts/sandbox/figures/correlations')
source(path(root, 'cor_viz_helpers/heat_maps/plot_heat_maps.r')) # plot_heat()
# Import libraries
rm(list=ls())
library(tidyverse)
library(paletteer)
library(arrow)
library(fs)
library(here)
# Import data
setwd(here())
data_root <- path('analysis/data/original')
fig_save_root <- path('analysis/scripts/sandbox/figures/figures_scratch')
# Add path to data and figure save root
# data_root <- path('path/to/data')
# fig_save_root <- path('path/to/figures)
dpath <- path(data_root, '../correlation_data/iccs.csv')
d <- read.csv(dpath)
setwd("~/Documents/scripts/eeg-fmri-ml/analysis/scripts/sandbox/figures/session_icc_steps")
# Import libraries
rm(list=ls())
library(tidyverse)
library(paletteer)
library(arrow)
library(fs)
library(here)
# Import data
setwd(here())
data_root <- path('analysis/data/original')
fig_save_root <- path('analysis/scripts/sandbox/figures/figures_scratch')
# Add path to data and figure save root
# data_root <- path('path/to/data')
# fig_save_root <- path('path/to/figures)
dpath <- path(data_root, '../correlation_data/iccs.csv')
d <- read.csv(dpath)
setwd("~/Documents/scripts/eeg-fmri-ml/analysis/scripts/sandbox/figures/session_icc_steps")
rm(list=ls())
library(reticulate)
library(tidyverse)
library(here)
library(RColorBrewer)
library(glue)
library(ggpubr)
library(fs)
fig_save_root <- path(here(), 'analysis/scripts/sandbox/figures/figures_scratch')
overall_text <- 18
script_root <- as.character(path(here(), 'analysis/scripts/sandbox/figures/eeg_timeseries'))
npy_files <- c(path(script_root, 'timeseries.npy'),
path(script_root, 'power.npy'))
if (!all(file.exists(npy_files))) stop('Must run python extract_timeseries.py path/to/data before this script.')
use_condaenv('eeg-fmri')
py_run_string('
import numpy as np
raw = np.load(f"{r.script_root}/timeseries.npy")
power = np.load(f"{r.script_root}/power.npy")
')
ch_names <- suppressWarnings(readLines(path(script_root, 'ch_names.txt')))
raw <- py$raw
power_in <- py$power
# Convert to long
dimnames(power_in) <- list(
sample = 1:dim(power_in)[1],
channel = ch_names,
freq = 1:40
)
power_in <- as.data.frame.table(power_in, responseName = 'power')
set.seed(42)
random_channel <- sample(ch_names, size = 1)
n_chans <- length(ch_names) %/% 3
random_channels <- sample(ch_names, size = n_chans)
if (!random_channel %in% random_channels) {
random_channels <- c(random_channels[1:(length(random_channels)-1)], random_channel)
}
# Get frequency bands
power <- power_in
power$freq <- as.numeric(power_in$freq)
breaks <- c(0, 1, 4, 8, 12, 30, 40)
labels <- c('init', 'Delta', 'Theta', 'Alpha', 'Beta', 'Gamma')
labels_simple <- tolower(labels[2:(length(labels))])
bins <- levels(cut(power$freq, breaks=breaks))
labels <- paste(labels, bins, sep=' ')
power <- power %>%
mutate(band = as.character(cut(freq, breaks, labels))) %>%
mutate(band = ifelse(band == 'init (0,1]', 'Delta (1,4]', band)) %>%
mutate(band = factor(band, levels = rev(unique(band)))) %>%
filter(channel == random_channel) %>%
group_by(sample, band) %>%
summarize(power = mean(power)) %>%
group_by(band) %>%
mutate(power = scale(power)[,1]) %>%
ungroup()
p1 <- power %>%
mutate(sample = as.numeric(sample)) %>%
mutate(time = (sample - min(sample)) / 250) %>%
ggplot(aes(x = time, y = power)) +
geom_line() +
facet_grid(band~.) +
labs(
x = 'Time (s)',
y = 'Power (normalized)'
) +
theme_bw() +
theme(axis.ticks = element_blank(),
panel.grid = element_blank(),
text = element_text(size = 18),
axis.text = element_text(size = 16),
strip.background = element_rect(fill = NA, color = 'black'))
p1
# TF plot
power <- power_in %>%
mutate(sample = as.numeric(sample),
freq = as.numeric(as.character(freq))) %>%
mutate(time = (sample - min(sample)) / 250)
green <- paletteer::paletteer_c('ggthemes::Green', n=100)
rdbu <- brewer.pal(11, 'RdBu')
rdbu <- rev(colorRampPalette(rdbu)(100))
clip_quantile <- .95
time_min <- 0
time_mid <- ceiling(max(power$time) / 2)
time_max <- max(power$time)
p2 <- power %>%
filter(channel == random_channel) %>%
mutate(power = ifelse(power > quantile(power, clip_quantile), quantile(power, clip_quantile), power)) %>%
ggplot(aes(x = time, y = freq)) +
geom_raster(aes(fill = power), interpolate = TRUE) +
labs(
x = 'Time (s)',
y = 'Frequency (Hz)',
fill = 'Power',
caption = glue('Channel: {random_channel}')
) +
scale_fill_gradientn(colors = rdbu) +
scale_x_continuous(breaks = c(time_min, time_mid, time_max),
labels = function(x) as.integer(x)) +
theme_bw() +
theme(panel.grid = element_blank(),
axis.ticks = element_blank(),
legend.position = 'bottom',
legend.text = element_text(angle = 45, hjust = 1, size = 10),
legend.title = element_text(size = 9),
legend.key.size = unit(.5, 'cm'),
text = element_text(size = overall_text))
p2
